version: '3.8'

services:
  # Self-hosted PeerJS signaling server
  peerjs-server:
    build:
      context: ./server
      dockerfile: Dockerfile.peerjs
    ports:
      - "9000:9000"
    networks:
      retro-network:
        ipv4_address: 172.28.0.10
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9001/"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Self-hosted TURN/STUN server (coturn)
  coturn:
    image: coturn/coturn:4.6
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "5349:5349"
      - "5349:5349/udp"
    volumes:
      - ./server/turnserver.conf:/etc/coturn/turnserver.conf:ro
    networks:
      retro-network:
        ipv4_address: 172.28.0.11
    command: ["-c", "/etc/coturn/turnserver.conf"]

  # Web server to serve the app
  webserver:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./:/usr/share/nginx/html:ro
      - ./server/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      retro-network:
        ipv4_address: 172.28.0.12
    depends_on:
      - peerjs-server
      - coturn

  # Browser instance 1 (Host)
  browser-host:
    build:
      context: ./tests
      dockerfile: Dockerfile.browser
    environment:
      - ROLE=host
      - APP_URL=http://webserver
      - RESULT_FILE=/results/host-result.json
    volumes:
      - ./test-results:/results
    networks:
      retro-network:
        ipv4_address: 172.28.0.20
    depends_on:
      webserver:
        condition: service_started
      peerjs-server:
        condition: service_healthy

  # Browser instance 2 (Client)
  browser-client:
    build:
      context: ./tests
      dockerfile: Dockerfile.browser
    environment:
      - ROLE=client
      - APP_URL=http://webserver
      - RESULT_FILE=/results/client-result.json
      - HOST_RESULT_FILE=/results/host-result.json
    volumes:
      - ./test-results:/results
    networks:
      retro-network:
        ipv4_address: 172.28.0.21
    depends_on:
      browser-host:
        condition: service_started

networks:
  retro-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

