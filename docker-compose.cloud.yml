version: '3.8'

services:
  # Web server to serve the app (using Google STUN + PeerJS cloud)
  webserver:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./:/usr/share/nginx/html:ro
      - ./server/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      retro-network:
        ipv4_address: 172.28.0.12

  # Browser instance 1 (Host) - connects via internet to PeerJS cloud
  browser-host:
    build:
      context: ./tests
      dockerfile: Dockerfile.browser
    environment:
      - ROLE=host
      - APP_URL=http://webserver?useLocalServers=false
      - RESULT_FILE=/results/host-result.json
    volumes:
      - ./test-results:/results
    networks:
      retro-network:
        ipv4_address: 172.28.0.20
    depends_on:
      webserver:
        condition: service_started

  # Browser instance 2 (Client) - connects via internet to PeerJS cloud
  browser-client:
    build:
      context: ./tests
      dockerfile: Dockerfile.browser
    environment:
      - ROLE=client
      - APP_URL=http://webserver?useLocalServers=false
      - RESULT_FILE=/results/client-result.json
      - HOST_RESULT_FILE=/results/host-result.json
    volumes:
      - ./test-results:/results
    networks:
      retro-network:
        ipv4_address: 172.28.0.21
    depends_on:
      browser-host:
        condition: service_started

networks:
  retro-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

